---
title: "Correlations"
author: "Kathleen Onorevole"
date: "September 13, 2016"
output: html_document
---

This is a relocated version of the correlations_processing script, formerly located in the PRIMER folder. It was feared that it would not be intuitive to find this folder in the future, so it was copied to the present location in the parent folder on 9/13/16. Hopefully none of the references will be corrupted.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Remember to set working directory**

Load the packages and functions needed for this analysis.
```{r libraries}

library(plyr)
library(dplyr)
library(car)
library(ggplot2)
library(ggpmisc)
library(lattice)
library(grid)
library(reshape2)
library(RColorBrewer)
library(gtable)
library(gridExtra)
library(cowplot)
library(MASS)

source("functions.R")

```

Read in the annual data, which has been previously worked up in the parent R Markdown files. Annual data contains data for each season; all averages contains the average value for each core type for the entire year.
```{r read.in}

annual.data <- read.csv("PRIMER\\raw\\annual-data_all-seasons_all-sites.csv", header = T, stringsAsFactors = F)

all.avgs <- read.csv("PRIMER\\raw\\all-data_annual-avg_all-sites.csv", header = T, stringsAsFactors = F)

spring <- read.csv("PRIMER\\raw\\all-data_spring15_all-sites.csv", header = T, stringsAsFactors = F)

sed.data <- read.csv("PRIMER\\raw\\sed-data_spring15_all-sites.csv", header = T, stringsAsFactors = F)

```

Eliminating NA values and add column for Age
```{r pretreat}

all.avgs.nona <- na.omit(all.avgs)
all.avgs.nona$Site <- factor(all.avgs.nona$Site, levels = c("IMS", "Carrot", "NOAA", "Army"))
all.avgs.nona$CoreName <- factor(all.avgs.nona$CoreName, levels = c("LO", "HO", "MM"))
all.avgs.nona$Habitat <- factor(all.avgs.nona$Habitat, levels = c("oyster", "marsh"))

sed.data$Site <- factor(sed.data$Site, levels = c("IMS", "Carrot", "NOAA", "Army"))
sed.data$CoreName <- factor(sed.data$CoreName, levels = c("LO", "HO", "LM", "MM", "HM", "Ref"))
sed.data$Habitat <- factor(sed.data$Habitat, levels = c("oyster", "marsh", "Ref"))

annual.data <- add.sandflat(annual.data)

annual.data <- add.age(annual.data)
annual.data$Age <- as.numeric(annual.data$Age)

annual.data <- set.factors.habitat(annual.data)

```

Viewing correlation info & scatterplot matrices for the two types of averaged data (by core and annually).
```{r correlation.values}

cor(annual.data[annual.data$Age, 5:11])
cor(annual.data[ , 5:11])

pairs(annual.data[, 5:11], upper.panel = panel.cor)
pairs(annual.data[, 9:11], upper.panel = panel.cor)

annual.data$Season <- factor(annual.data$Season, level = c("Summer", "Fall", "Winter", "Spring"))

pairs(annual.data[annual.data$Season == "Summer", 5:11], upper.panel = panel.cor)

#Creating scatterplot matrix for only spring values (relevant for sediment parameters)
spring.nona <- na.omit(spring)
sed.data.nona <- na.omit(sed.data)
all.sed <- inner_join(sed.data.nona, spring.nona)

pairs(all.avgs.nona[ , 4:12], upper.panel = panel.cor)
pairs(all.avgs.nona[ , 5:8], upper.panel = panel.cor)

```

Checking for validity of assumptions (heterogeneity of variances & normality) for regression using Bartlett & Shapiro-Wilk tests, respectively. Checking on both annual and seasonal groupings of variables as relevant.
```{r assumption.checks}

#Remember: Check for homoegeneity of variances w Bartlett test. If p>0.05, cannot reject null that variance is same -- so the sample passes.

#Checking for normality using Shapiro-Wilk with previously-written code to spell out results. Shapiro-Wilk tests AGAINST assumption of normality: aka, if p<0.05, the samples are likely to be non-normal. This is confusing which is why I've written the code.

###Annual N2 flux###

#Fails Bartlett, p = 0.03
bartlett.test(N2Flux ~ Site, data = annual.data)

#Everything passes except for Army...
test.norm.N2 <- annual.data %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(N2Flux)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

##Use Box Cox transformation to attempt correction since log transformation failed

#Eliminate all but relevant columns for simplicity; transformed values will be added as new columns. Also convert Age to a factor b/c it was previously numeric.
drops <- c("O2conc", "PercentInundation", "NOxFlux", "NH3Flux")
annual.fix <- annual.data[ , !(names(annual.data) %in% drops)]
annual.fix$Age <- factor(annual.fix$Age, levels = c("0", "2", "7", "20"))

#Start by finding the optimal value of lambda

#Create a column with positive values of N2 by adding 10 to each flux
annual.fix <- mutate(annual.fix,
                  PosN2 = N2Flux + 10)
#Create a log-likelihood graph using a command from the MASS package
bctrans <- boxcox(PosN2 ~ Age, data = annual.fix,
                    lambda = seq(0, 1, by = 0.1))
#Identify the maximum likelihood value
which.max(bctrans$y)
#Use that maximum likelihood value (from the y axis) to determine the associated lambda (on the x axis)
bctrans$x[which.max(bctrans$y)]

#Take the variable to the power of the lambda to perform the transformation!
annual.fix <- mutate(annual.fix,
                     N2BoxCox = (((PosN2 ^ 0.545) - 1) / 0.545))

#Passes Bartlett, p = 0.057
bartlett.test(N2BoxCox ~ Site, data = annual.fix)

#Army still fails, but is closer: p = 0.022 vs 0.0007
test.norm.BCN2 <- annual.fix %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(N2BoxCox)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))


#Adding age again as a numerical value rather than factor
trial <- add.num.age(annual.fix)

#The regression of the transformed N2 flux data against age doesn't look that bad, and the stats aren't too different from the untransformed fluxes. Both are signif with p = 0.05 and have R2 ~ 0.3 (R2 is slightly higher for the untransformed).
trial %>%
  ggplot(aes(NumAge, N2BoxCox)) +
  geom_point() +
  geom_smooth(method = "lm", formula = quad.formula)

model <- lm(trial$N2BoxCox ~ poly(trial$NumAge,2))
summary(model)

#subsetting annual.fix to create a new data frame with only tranformed summer data for testing
summer.BCtest <- annual.fix %>%
  filter(Season == "Summer") %>%
  group_by(Site)

#Running checks on transformed summer N2 Flux data-- passes all
bartlett.test(N2BoxCox ~ Site, data = summer.BCtest)

test.norm.BCsumN2 <- summer.BCtest %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(N2BoxCox)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

###Annual SOD###

#Passes Bartlett!
bartlett.test(SOD ~ Site, data = annual.data)

#Army & Carrot fail normality.
test.norm.SOD <- annual.data %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(SOD)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

#Implement a Box Cox transformation to correct

#Start by finding the optimal value of lambda
#Create a log-likelihood graph using a command from the MASS package
bctrans2 <- boxcox(SOD ~ Age, data = annual.fix,
                    lambda = seq(0, 1, by = 0.1))
#Identify the maximum likelihood value
which.max(bctrans2$y)
#Use that maximum likelihood value (from the y axis) to determine the associated lambda (on the x axis)
bctrans2$x[which.max(bctrans2$y)]

#Take the variable to the power of the lambda to perform the transformation!
annual.fix <- mutate(annual.fix,
                     SODBoxCox = (((SOD ^ 0.192) - 1) / 0.192))
annual.fixtemp <- mutate(annual.fix,
                         log.SOD = log(SOD, 10),
                         ln.SOD = log(SOD))

#Passes Bartlett still, and normality is better: Carrot passes and Army still fails, but better (p = 0.01 vs 0.000002)
test.norm.BCSOD2 <- annual.fixtemp %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(log.SOD)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

#Adding age as a numerical value to facilitate graphing (below)
trial2 <- add.num.age(annual.fixtemp)

#Visualizing the transformed & untransformed data, respectively. Pretty much same shape of regression curve but units are VERY different.
p9 <- ggplot(trial2, aes(NumAge, log.SOD))
p9 + geom_point() + geom_smooth(method = "lm", formula = quad.formula)

p10 <- ggplot(trial2, aes(NumAge, SOD))
p10 + geom_point() + geom_smooth(method = "lm", formula = quad.formula)

#Both give bad R2 (untrans: 0.13, trans: 0.16) and both have signif p-values.
model2 <- lm(trial2$SOD ~ poly(trial2$NumAge, 2))
summary(model2)

model3 <- lm(trial2$log.SOD ~ poly(trial2$NumAge, 2))
summary(model3)


annual.data %>%
  ggplot(aes(Age, SOD)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ log(x + .001), size = 2) +
  stat_poly_eq(formula = y ~ log(x + .001),
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 parse = T) +
   stat_fit_glance(method = "lm",
                   method.args = list(formula = y ~ log(x + .001),
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right"))

##Summer N2 flux

#Create subset data frame with only summer data to run test on N2 Flux, to ultimately add a dotted line for summer N2 flux trajectory. This is a modified version of the broader seasonal regressions that were conducted earlier in analysis to explore trends.
summer.test <- annual.data %>%
  filter(Season == "Summer") %>%
  group_by(Site)

#passes Bartlett
bartlett.test(N2Flux ~ Site, data = summer.test)

#Carrot fails normality
test.norm.sumN2 <- summer.test %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(N2Flux)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

##Annual SOM

#fails Bartlett test, p = 1.2 E-8
bartlett.test(PercentOM ~ Site, data = annual.data)

#IMS & Carrot fail normality
test.norm.SOM <- annual.data %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(PercentOM)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

#First attempted BoxCox transform but it didn't work- possibly b/c it's a %?
#Created new data frame to attempt transformations of SOM. Includes the column SOM which is PercentOM changed to a proportion rather than a %.
#Attempt arcsin transformation, which wasn't helpful: still failed same checks. Then attempted logit transformation.
annual.fix2 <- mutate(annual.fix,
                      SOM = PercentOM / 100,
                      sqrootSOM = sqrt(SOM),
                      arcsinSOM = asin(sqrootSOM),
                      logitSOM = log(SOM / (1-SOM)))

#Logit transform fails Barlett but better (p = 0.002) and all pass normality
bartlett.test(logitSOM ~ Age, annual.fix2)

test.norm.logitSOM <- annual.fix2 %>%
    group_by(Site) %>%
    summarise(SW.pvalue = shapiro.test(logitSOM)$p.value) %>%
    mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

trial3 <- add.num.age(annual.fix2)

#Visualizing the transformed & untransformed data, respectively. Pretty much same shape of regression curve but units are VERY different.
p11 <- ggplot(trial3, aes(NumAge, logitSOM))
p11 + geom_point() + geom_smooth(method = "lm", formula = quad.formula)

p12 <- ggplot(trial3, aes(NumAge, SOM))
p12 + geom_point() + geom_smooth(method = "lm", formula = quad.formula)

#Transformed data gives better R2 (0.47 vs 0.39)-- **altho might be worth running an ANOVA to check if the difference is significant (see saved R-Bloggers page for info)**. p-values are signif in both cases.
model4 <- lm(trial3$SOM ~ poly(trial3$NumAge, 2))
summary(model4)

model5 <- lm(trial3$logitSOM ~ poly(trial3$NumAge, 2))
summary(model5)


##Spring bulk density

#Fails Bartlett, p = 0.01
bartlett.test(BulkDensity ~ Site, data = sed.data)

#All pass
test.norm.BD <- sed.data %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(BulkDensity)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

#Unable to find a transformation that passes the assumptions using the standard set of transformations and Box Cox. (Got same error as with SOM for bulk density for Box Cox, where max value was 100 and resulting x value was 0. Not sure what's causing that to happen, but it's probably something theoretical.)
sed.fix <- mutate(sed.data,
                  log.BD = log(BulkDensity, 10),
                  sqroot.BD = sqrt(BulkDensity),
                  BDsquared = BulkDensity ^ 2,
                  ln.BD = log(BulkDensity),
                  cuberoot.BD = BulkDensity ^ (1/3),
                  logplus.BD = log(BulkDensity + 1, 10))

sed.fix$Age <- factor(sed.fix$Age, levels = c("0", "2", "7", "20"))

bartlett.test(log.BD ~ Site, sed.fix)

p1 <- ggplot(sed.fix, aes(Age, BulkDensity))
p1 + geom_point(aes(colour = CoreName)) +
  coord_cartesian(ylim = c(0,2))
lmBD <- lm(BulkDensity ~ Age, sed.fix)
par(mfrow = c(2,2))
plot(lmBD)

lmtest::bptest(lmBD)

```

Visualize the various parameters across age, per the restoration trajectory model. This can probably be modified to show whatever parameters are of interest, but seems really practical for a figure!
```{r regression}

#Creating a formula for a log fit. Need to add 10 to make the #s all positive
ln.formula <- y ~ log(x + 10)

#Regression is 2nd order polynomial based on expectations (not linear) and data
quad.formula <- y ~ poly(x,2)

#Melt the data to create 2 columns:parameter names and values
#To be used in below analysis
melted.annual <- melt(annual.data, measure.vars = c("O2conc", "SOD", "PercentOM", "PercentInundation", "NOxFlux", "NH3Flux", "N2Flux")) 

#Separate the data so SOD & N2 flux are together, and SOM and BD are together
melted.1 <- melted.annual[melted.annual$variable == "SOD" | melted.annual$variable == "N2Flux", ]

melted.1 %>%
  filter(variable == "N2Flux") %>%
  ggplot(aes(Age, value)) +
  geom_point() +
  geom_smooth(method = "lm", formula = quad.formula, se = F) +
  stat_poly_eq(formula = y ~ poly(x,2),
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 parse = T) +
  stat_fit_glance(method = "lm",
                  method.args = list(formula = quad.formula),
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")

melted.1a <- mutate(melted.1, pos.value = value + 10)



p1 <- ggplot(annual.data)
p1 + stat_qq(aes(sample = SOD)) + geom_smooth(aes(colour = Site), method = "lm")
shapiro.test(SOD ~ Age, data = annual.data)

test.norm.Age <- annual.data %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(SOD)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

annual.data %>%
  ggplot(aes(SOD)) +
  geom_histogram(stat = "bin", binwidth = 5) +
  facet_grid(Site ~ .)

bartlett.test(SOD ~ Site, data = annual.data)

trans.Site <- annual.data %>%
  mutate(log_SOD = log(SOD, 10),
         SOD2 = SOD^2)




summary(lm(annual.data$SOD ~ cbind(annual.data$Age, log(annual.data$Age + 10))))

melted.1a %>%
  ggplot(aes(Age, pos.value)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free_y") +
  geom_smooth()

#Get rid of NA values and percent inundation (b/c that wouldn't be expected to change w age)
melted.annual <- na.omit(melted.annual)
melted.annual <- melted.annual[!melted.annual$variable == "PercentInundation", ]

#Code from Adam to check that linear regression values are being calculated accurately
#LM check - linear
summary(lm(annual.data$SOD~annual.data$Age))
#LM check - quadratic
summary(lm(annual.data$O2conc~cbind(annual.data$Age,annual.data$Age^2)))

#ANNUAL CONSIDERATION OF PARAMETERS CONSIDERED SEASONALLY
#Seasonal parameters visualized for the entire year with a single linear regression line
#Not broken up by habitat
#Only % OM has significant p-value and decent R2
melted.annual %>%
  ggplot(aes(Age, value)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free_y") +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), size = 1) +
  stat_poly_eq(formula = y ~ poly(x,2),
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 parse = T) +
  stat_fit_glance(method = "lm",
                  method.args = list(formula = quad.formula),
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")

#Same as above but visualized with a separate line for each habitat
#Fitted with 2nd order polynomial equation
#Looks like %OM may have a good story! Strong R2 and p values for all habitats
melted.annual %>%
  ggplot(aes(Age, value, colour = Habitat)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free_y") +
  geom_smooth(method = "lm", formula = quad.formula, se = F, size = 1) +
  stat_poly_eq(formula = quad.formula,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), parse = T) +
  stat_fit_glance(method = "lm",
                  method.args = list(formula = quad.formula),
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")

#SEASONAL CONSIDERATIONS OF VARIABLES COLLECTED EVERY SEASON
#Filter function to present each season individually; not divided by habitat
#N2 flux results are interesting for Summer; no other seasons provide new info
melted.annual %>%
  filter(Season == "Summer") %>%
  ggplot(aes(Age, value)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free_y") +
  geom_smooth(method = "lm", formula = quad.formula, size = 1) +
  stat_poly_eq(formula = quad.formula,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               parse = T, label.y.npc = "top") +
  stat_fit_glance(method = "lm",
                  method.args = list(formula = quad.formula),
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")

#Divided by season and visualized with a separate regression line for each habitat
#Modify the season filter to show one season at a time; can also change the color of the pts
melted.annual %>%
  filter(Season == "Spring") %>%
  ggplot(aes(Age, value, colour = Habitat)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free_y") +
  geom_smooth(method = "lm", formula = quad.formula, se = F, size = 1) +
  stat_poly_eq(formula = quad.formula,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               parse = T, label.y.npc = "top") +
  stat_fit_glance(method = "lm",
                  method.args = list(formula = quad.formula),
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")


#Prep sediment data in the same way as above
#This data set contains only CHN and bulk density data, matched with corresponding spring N2 fluxes
sed.data <- add.age(sed.data)
sed.data$Age <- as.numeric(sed.data$Age)

melted.sed <- melt(sed.data, measure.vars = c("PercentC", "PercentN", "CtoN", "BulkDensity", "SpringN2"))

#Graphing linear regression with age for sed parameters
#The regression lines & stats are the same whether NA lines are included or not
#So not necessary to create a data frame without NAs (ignore warnings)
melted.sed %>%
  ggplot(aes(Age, value)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free_y") +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), size = 1) +
  stat_poly_eq(formula = y ~ poly(x,2),
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 parse = T) +
   stat_fit_glance(method = "lm",
                   method.args = list(formula = quad.formula),
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")

melted.sed %>%
  ggplot(aes(Age, value)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free_y") +
  geom_smooth(method = "lm", formula = quad.formula, size = 1) +
  stat_poly_eq(formula = quad.formula,
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 parse = T) +
   stat_fit_glance(method = "lm",
                   method.args = list(formula = quad.formula),
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")

#LM check - linear
summary(lm(sed.data$BulkDensity~sed.data$Age))

#LM check - quadratic
summary(lm(sed.data$BulkDensity~cbind(sed.data$Age,sed.data$Age^2)))


melted.sed %>%
  ggplot(aes(Age, value)) +
  geom_point(aes(colour = Habitat)) +
  facet_grid(variable ~ ., scales = "free_y") +
  geom_smooth(aes(colour = Habitat), method = "lm", formula = y ~ poly(x,2), se = F, size = 1) +
  stat_poly_eq(formula = y ~ poly(x,2),
                 aes(colour = Habitat, label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 parse = T) +
   stat_fit_glance(method = "lm",
                  geom = "text",
                  aes(colour = Habitat, label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")


###Everything below here will probably be eliminated- old work

all.avgs.nona <- add.age(all.avgs.nona)
all.avgs.nona$Age <- as.numeric(all.avgs.nona$Age)

melted.avgs <- melt(all.avgs.nona, measure.vars = c("Inundation", "PercentC", "PercentN", "CtoN", "PercentOM", "SOD", "O2conc", "BulkDensity", "N2Flux"))

melted.avgs %>%
  ggplot(aes(Age, value)) +
  geom_point(aes(colour = Habitat)) +
  facet_grid(variable ~ ., scales = "free_y") +
  geom_smooth(aes(colour = Habitat), method = "lm", formula = y ~ poly(x,2), se = F, size = 1) +
  stat_poly_eq(formula = y ~ poly(x,2),
                 aes(colour = Habitat, label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 parse = T) +
  stat_fit_glance(method = "lm",
                  geom = "text",
                  aes(colour = Habitat, label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")


#Set factors for spring-only data frame (This may change if I clean up the original)
#The sediment parameters were measured in spring 2015, so this data set includes matching BGC
#parameters from only spring 2015
spring <- add.age(spring)
spring$Age <- as.numeric(spring$Age)
spring$Site <- factor(spring$Site, levels = c("IMS", "Carrot", "NOAA", "Army"))
spring$Habitat <- factor(spring$Habitat, levels = c("oyster", "marsh", "ref"))

spring <- add.age(spring)
spring$Age <- as.numeric(spring$Age)

#Melt the spring data frame as before
melted.spring <- melt(spring, measure.vars = c("Inundation", "PercentC", "PercentN", "CtoN", "BulkDensity", "SpringPercentOM", "SpringSOD", "SpringO2", "SpringN2"))

melted.spring <- na.omit(melted.spring)

#Graph restoration trajectory of spring only values as before
#Bulk density, %C, %N, %OM, SOD, [O2] all look good re: R2 and p-values
melted.spring %>%
  ggplot(aes(Age, value)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free_y") +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), size = 1) +
  stat_poly_eq(formula = y ~ poly(x,2),
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 parse = T) +
   stat_fit_glance(method = "lm",
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")

```

Polished figures created for my defense.
```{r defense.figs}

#Annual N2 regression with age
tiff("Annual N2 regression", width = 500, height = 160, units = "mm", res = 300, compression = "lzw")

annual.data %>%
  ggplot(aes(Age, N2Flux)) +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  geom_point(size = 4) +
  theme(panel.background = element_rect(fill = "white", colour = NA),
       axis.title.x = element_text(margin = margin(t = 15), size = 28),
       axis.title.y = element_text(margin = margin(r = 15), size = 28),
       axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_text(size = 20, colour = "black"),
       axis.text.y = element_text(size = 20, colour = "black")) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = F, size = 2) +
  xlab("Restored age (years)") +
  ylab(expression(paste("Average ", N[2], " flux (", mu, "mol N ", m^2, " ", h^-1, ")"))) +
  coord_cartesian(ylim = c(-10, 120)) +
  scale_y_continuous(breaks = seq(-20, 120, 20))
  
dev.off()

#Summer N2 vs age
tiff("Summer N2 regression", width = 500, height = 160, units = "mm", res = 300, compression = "lzw")

annual.data %>%
  filter(Season == "Summer") %>%
  ggplot(aes(Age, N2Flux)) +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  geom_point(size = 4) +
  theme(panel.background = element_rect(fill = "white", colour = NA),
       axis.title.x = element_text(margin = margin(t = 15), size = 28),
       axis.title.y = element_text(margin = margin(r = 15), size = 28),
       axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_text(size = 20, colour = "black"),
       axis.text.y = element_text(size = 20, colour = "black")) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = F, size = 2) +
  xlab("Restored age (years)") +
  ylab(expression(paste("Average ", N[2], " flux (", mu, "mol N ", m^2, " ", h^-1, ")"))) +
  coord_cartesian(ylim = c(-10, 120)) +
  scale_y_continuous(breaks = seq(-20, 120, 20))
  
dev.off()

#Fall N2 vs age
tiff("Fall N2 regression", width = 500, height = 160, units = "mm", res = 300, compression = "lzw")

annual.data %>%
  filter(Season == "Fall") %>%
  ggplot(aes(Age, N2Flux)) +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  geom_point(size = 4) +
  theme(panel.background = element_rect(fill = "white", colour = NA),
       axis.title.x = element_text(margin = margin(t = 15), size = 28),
       axis.title.y = element_text(margin = margin(r = 15), size = 28),
       axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_text(size = 20, colour = "black"),
       axis.text.y = element_text(size = 20, colour = "black")) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = F, size = 2) +
  xlab("Restored age (years)") +
  ylab(expression(paste("Average ", N[2], " flux (", mu, "mol ", N[2], " ", m^2, " ", h^-1, ")"))) +
  coord_cartesian(ylim = c(-10, 120)) +
  scale_y_continuous(breaks = seq(-20, 120, 20))
  
dev.off()


#Annual N2 vs age, with separate lines for each habitat

annual.data.sand <- add.sandflat(annual.data)
annual.data.sand$Habitat <- factor(annual.data.sand$Habitat, levels = c("oyster", "marsh", "sandflat"))
annual.data.sand <- set.factors.habitat(annual.data.sand)

tiff("Annual N2 regression by Habitat", width = 400, height = 160, units = "mm", res = 300, compression = "lzw")

annual.data.sand %>%
  ggplot(aes(Age, N2Flux, colour = Habitat)) +
  geom_point(size = 4) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = F, size = 2) +
  theme(panel.background = element_rect(fill = "white", colour = NA),
       axis.title.x = element_text(margin = margin(t = 15), size = 28),
       axis.title.y = element_text(margin = margin(r = 15), size = 28),
       axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_text(size = 20, colour = "black"),
       axis.text.y = element_text(size = 20, colour = "black"),
       legend.title = element_text(size = 23, face = "bold"),
       legend.text = element_text(size = 20)) +
  scale_colour_manual(values = c("darkorchid4", "olivedrab", "darkgoldenrod"),
                      labels = c("  oyster",
                                 "  marsh",
                                 "  sandflat")) +
  xlab("Restored age (years)") +
  ylab(expression(paste("Average ", N[2], " flux (", mu, "mol N ", m^2, " ", h^-1, ")"))) +
  coord_cartesian(ylim = c(-10, 120)) +
  scale_y_continuous(breaks = seq(-20, 120, 20))

dev.off()

#Annual SOM regression with age
tiff("Annual SOM regression", width = 500, height = 160, units = "mm", res = 300, compression = "lzw")

annual.data %>%
  ggplot(aes(Age, PercentOM)) +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  geom_point(size = 4) +
  theme(panel.background = element_rect(fill = "white", colour = NA),
       axis.title.x = element_text(margin = margin(t = 15), size = 26),
       axis.title.y = element_text(margin = margin(r = 15), size = 26),
       axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_text(size = 20, colour = "black"),
       axis.text.y = element_text(size = 20, colour = "black")) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = F, size = 2) +
  xlab("Restored age (years)") +
  ylab("SOM (%)") +
  coord_cartesian(ylim = c(0, 10)) +
  scale_y_continuous(breaks = seq(0, 10, 2))
  
dev.off()

#Annual SOM regression with age, with a separate line for each habitat
tiff("Annual SOM regression by Habitat", width = 500, height = 160, units = "mm", res = 300, compression = "lzw")

annual.data.sand %>%
  ggplot(aes(Age, PercentOM, colour = Habitat)) +
  geom_point(size = 4) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = F, size = 2) +
  theme(panel.background = element_rect(fill = "white", colour = NA),
       axis.title.x = element_text(margin = margin(t = 15), size = 26),
       axis.title.y = element_text(margin = margin(r = 15), size = 26),
       axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_text(size = 20, colour = "black"),
       axis.text.y = element_text(size = 20, colour = "black"),
       legend.title = element_text(size = 23, face = "bold"),
       legend.text = element_text(size = 20)) +
  scale_colour_manual(values = c("darkorchid4", "olivedrab", "darkgoldenrod"),
                      labels = c("  oyster",
                                 "  marsh",
                                 "  sandflat")) +
  xlab("Restored age (years)") +
  ylab("SOM (%)") +
  coord_cartesian(ylim = c(0, 10)) +
  scale_y_continuous(breaks = seq(0, 10, 2))

dev.off()

tiff("Annual N2 regression by SOD", width = 300, height = 200, units = "mm", res = 300, compression = "lzw")

annual.data %>%
  ggplot(aes(SOD, N2Flux)) +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  geom_point(size = 4) +
  theme(panel.background = element_rect(fill = "white", colour = NA),
       axis.title.x = element_text(margin = margin(t = 15), size = 26),
       axis.title.y = element_text(margin = margin(r = 15), size = 26),
       axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_text(size = 20, colour = "black"),
       axis.text.y = element_text(size = 20, colour = "black")) +
  geom_smooth(method = "lm", formula = y ~ x, se = F, size = 2) +
  xlab(expression(paste(" Average SOD (", mu, "mol ", O[2], " ", m^2, " ", h^-1, ")"))) +
  ylab(expression(paste("Average ", N[2], " flux (", mu, "mol ", N[2], " ", m^2, " ", h^-1, ")"))) +
  coord_cartesian(ylim = c(-10, 120)) +
  scale_y_continuous(breaks = seq(-20, 120, 20))

dev.off()

tiff("Summer N2 regression by SOM", width = 300, height = 200, units = "mm", res = 300, compression = "lzw")

annual.data %>%
  filter(Season == "Summer") %>%
  ggplot(aes(PercentOM, N2Flux)) +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  geom_point(size = 4) +
  theme(panel.background = element_rect(fill = "white", colour = NA),
       axis.title.x = element_text(margin = margin(t = 15), size = 26),
       axis.title.y = element_text(margin = margin(r = 15), size = 26),
       axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_text(size = 20, colour = "black"),
       axis.text.y = element_text(size = 20, colour = "black")) +
  geom_smooth(method = "lm", formula = y ~ x, se = F, size = 2) +
  xlab("Sediment organic matter (SOM) (%)") +
  ylab(expression(paste("Average ", N[2], " flux (", mu, "mol ", N[2], " ", m^2, " ", h^-1, ")"))) +
  coord_cartesian(ylim = c(-10, 120), xlim = c(0, 6)) +
  scale_y_continuous(breaks = seq(-20, 120, 20))

dev.off()


tiff("All correlations", width = 300, height = 200, units = "mm", res = 300, compression = "lzw")

pairs(annual.data[, 5:11], upper.panel = panel.cor)

dev.off()

annual.data <- set.factors.basic(annual.data)

tiff("Annual N2 regression by SOD, divided by Habitat", width = 300, height = 200, units = "mm", res = 300, compression = "lzw")

annual.data %>%
  ggplot(aes(SOD, N2Flux, colour = Season)) +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  geom_point(size = 4) +
  theme(panel.background = element_rect(fill = "white", colour = NA),
       axis.title.x = element_text(margin = margin(t = 15), size = 26),
       axis.title.y = element_text(margin = margin(r = 15), size = 26),
       axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_text(size = 20, colour = "black"),
       axis.text.y = element_text(size = 20, colour = "black"),
       legend.title = element_text(size = 23, face = "bold"),
       legend.text = element_text(size = 20)) +
  xlab(expression(paste(" Average SOD (", mu, "mol ", O[2], " ", m^2, " ", h^-1, ")"))) +
  ylab(expression(paste("Average ", N[2], " flux (", mu, "mol N ", m^2, " ", h^-1, ")"))) +
  coord_cartesian(ylim = c(-10, 120)) +
  scale_y_continuous(breaks = seq(-20, 120, 20)) +
  scale_colour_manual(values = c("darkgoldenrod1", "darkred", "darkblue", "darkgreen"),
                         labels = c("  Summer",
                                 "  Fall",
                                 "  Winter",
                                 "  Spring"))

dev.off()

```

Figures included in my initial thesis submission. These are cleaner than the figures originally created during general data exploration, but were improved in the following chunk of code for final submission to the graduate school.
```{r thesis.figs}

#Creating a new melted dataframe that does not include [O2], NOx flux, or NH3 flux
melted.annual2 <- melted.annual[!melted.annual$variable == "O2conc", ]
melted.annual2 <- melted.annual2[!melted.annual2$variable == "NOxFlux", ]
melted.annual2 <- melted.annual2[!melted.annual2$variable == "NH3Flux", ]

#The only sediment parameter that will be included in the regression graphs is bulk density
#Add a column for Season to the sediment parameters dataframe and populate it with Spring
#Rearrange columns so Season is 1st column per convention
melted.sed$Season <- c("Spring")
melted.sed2 <- melted.sed[, c("Season", "Site", "CoreName", "Habitat", "Age", "variable", "value")]

#Extract only bulk density values from the sediment df and join it to the other df
bulk.density <- melted.sed2[melted.sed2$variable == "BulkDensity", ]
sed.join <- full_join(melted.annual2, bulk.density)

#Reorder the variables for graph purposes and change the Ref label so they match
sed.join$variable <- factor(sed.join$variable, levels = c("SOD", "PercentOM", "BulkDensity", "N2Flux"))
sed.join$Habitat <- revalue(sed.join$Habitat, c("ref" = "Ref"))
sed.join$Habitat <- factor(sed.join$Habitat, c("oyster", "marsh", "Ref"))

#All data visualized with one regression line; not divided by habitat
#Includes every season of data for SOD, %OM, and N2 flux
#Includes ONLY spring 2015 for bulk density b/c that was the only season measured
sed.join %>%
  ggplot(aes(Age, value)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free_y") +
  geom_smooth(method = "lm", formula = quad.formula, size = 1) +
  stat_poly_eq(formula = quad.formula,
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 parse = T) +
  stat_fit_glance(method = "lm",
                  method.args = list(formula = quad.formula),
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")

#Same as above but visualized with a separate line for each habitat
#Fitted with 2nd order polynomial equation
#Looks like %OM may have a good story! Strong R2 and p values for all habitats
sed.join %>%
  ggplot(aes(Age, value, colour = Habitat)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free_y") +
  geom_smooth(method = "lm", formula = quad.formula, se = F, size = 1) +
  stat_poly_eq(formula = quad.formula,
                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                 parse = T) +
   stat_fit_glance(method = "lm",
                   method.args = list(formula = quad.formula),
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")

#Only annual data (no bulk density) for summer, not divided by habitat
sed.join %>%
  filter(Season == "Summer") %>%
  ggplot(aes(Age, value)) +
  geom_point() +
  facet_grid(variable ~ ., scales = "free_y") +
  geom_smooth(method = "lm", formula = quad.formula, size = 1) +
  stat_poly_eq(formula = quad.formula,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               parse = T, label.y.npc = "top") +
  stat_fit_glance(method = "lm",
                  method.args = list(formula = quad.formula),
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")

```

Revised versions of the above figures to be included in my final thesis. Same data visualized, but done so in a much more polished fashion that matches the format used in the defense.
```{r thesis.revisions}

#Changing reference to sandflat and adding factor levels
sed.join <- add.sandflat(sed.join)
sed.join <- set.factors.habitat(sed.join)

#Creating stacked restoration trajectories for sediment parameters collected every season (SOD, SOM, bulk density, N2 flux) against restored age. This requires making a single graph for each parameter using the melted data set, then combining them all with grid.draw.

#First creating separate graphs for each variable. The first 3 do not have x axis labels or titles so there's just a single x axis at the very bottom.

p1.SOD <- sed.join %>%
  filter(variable == "SOD") %>%
  ggplot(aes(Age, value)) +
  geom_point(size = 2) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = F, size = 1, colour = "mediumblue") +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  theme(panel.background = element_rect(fill = "grey96", colour = NA),
       axis.title.x = element_blank(),
       axis.title.y = element_text(margin = margin(r = 20), size = 15),
       #axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_blank(),
       axis.text.y = element_text(size = 12, colour = "black")) +
    ylab(expression(paste("SOD (", mu, "mol ", O[2], " ", m^-2, " ", h^-1, ")")))

p2.SOM <- sed.join %>%
  filter(variable == "PercentOM") %>%
  ggplot(aes(Age, value)) +
  geom_point(size = 2) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = F, size = 1, colour = "mediumblue") +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  theme(panel.background = element_rect(fill = "grey96", colour = NA),
       axis.title.x = element_blank(),
       axis.title.y = element_text(margin = margin(r = 20), size = 15),
       #axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_blank(),
       axis.text.y = element_text(size = 12, colour = "black")) +
    ylab(expression(paste("SOM (%)")))

p3.BD <- sed.join %>%
  filter(variable == "BulkDensity") %>%
  ggplot(aes(Age, value)) +
  geom_point(size = 2) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = F, size = 1, colour = "mediumblue") +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  theme(panel.background = element_rect(fill = "grey96", colour = NA),
       axis.title.x = element_blank(),
       axis.title.y = element_text(margin = margin(r = 20), size = 15),
       #axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_blank(),
       axis.text.y = element_text(size = 12, colour = "black")) +
    ylab(expression(paste("Bulk Density (g ", cm^-3, ")")))

p4.N2 <- sed.join %>%
  filter(variable == "N2Flux") %>%
  ggplot(aes(Age, value)) +
  geom_point(size = 2) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = F, size = 1, colour = "mediumblue") +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  theme(panel.background = element_rect(fill = "grey96", colour = NA),
       axis.title.x = element_text(margin = margin(t = 15), size = 15),
       axis.title.y = element_text(margin = margin(r = 20), size = 15),
       axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_text(size = 12, colour = "black"),
       axis.text.y = element_text(size = 12, colour = "black")) +
  xlab("Restored Age (years)") +
  ylab(expression(paste(N[2], " flux (", mu, "mol N ", m^-2, " ", h^-1, ")")))

#Using the grid package to put them all together.
grid.newpage()

tiff("Figures\\Thesis\\RT-seasonal-sed-params", width = 350, height = 250, units = "mm", res = 300, compression = "lzw")

grid.draw(rbind(ggplotGrob(p1.SOD), ggplotGrob(p2.SOM), ggplotGrob(p3.BD), ggplotGrob(p4.N2),
                size = "last"))

dev.off()



###Plotting sediment characteristics collected seasonally for an entire year (same as above), divided by habitat. Requires creating separate plots and a legend, which is the first chunk of code. Those plots are then combined to create a final cluster of plots.

#Creating plot only to extract a relevant legend
legend.plot <- sed.join %>%
  filter(variable == "SOD") %>%
  ggplot(aes(Age, value, colour = Habitat)) +
  geom_point(size = 2) +
  geom_smooth(aes(colour = Habitat), method = "lm", formula = y ~ poly(x,2), se = F, size = 1) +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  theme(panel.background = element_rect(fill = "grey96", colour = NA),
       axis.title.x = element_blank(),
       axis.title.y = element_text(margin = margin(r = 20), size = 15),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_blank(),
       axis.text.y = element_text(size = 12, colour = "black"),
       legend.text = element_text(size = 15),
       legend.title = element_text(size = 20)) +
  coord_cartesian(xlim = c(0, 20)) +
  ylab(expression(paste("SOD (", mu, "mol ", O[2], " ", m^-2, " ", h^-1, ")"))) +
  scale_colour_manual(values = c("darkorchid4", "olivedrab", "darkgoldenrod"),
                      labels = c("  oyster",
                                 "  marsh",
                                 "  sandflat"))

#Creating the plots of the 4 parameters

p5.SOD <- sed.join %>%
  filter(variable == "SOD") %>%
  ggplot(aes(Age, value, colour = Habitat)) +
  geom_point(size = 2) +
  geom_smooth(aes(colour = Habitat), method = "lm", formula = y ~ poly(x,2), se = F, size = 1) +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  theme(panel.background = element_rect(fill = "grey96", colour = NA),
       axis.title.x = element_blank(),
       axis.title.y = element_text(margin = margin(r = 20), size = 15),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_blank(),
       axis.text.y = element_text(size = 12, colour = "black"),
       legend.position = "none") +
  coord_cartesian(xlim = c(0, 20)) +
  ylab(expression(paste("SOD (", mu, "mol ", O[2], " ", m^-2, " ", h^-1, ")"))) +
  scale_colour_manual(values = c("darkorchid4", "olivedrab", "darkgoldenrod"),
                      labels = c("  oyster",
                                 "  marsh",
                                 "  sandflat"))

p6.SOM <- sed.join %>%
  filter(variable == "PercentOM") %>%
  ggplot(aes(Age, value, colour = Habitat)) +
  geom_point(size = 2) +
  geom_smooth(aes(group = Habitat), method = "lm", formula = y ~ poly(x,2), se = F, size = 1) +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  theme(panel.background = element_rect(fill = "grey96", colour = NA),
       axis.title.x = element_blank(),
       axis.title.y = element_text(margin = margin(r = 20), size = 15),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_blank(),
       axis.text.y = element_text(size = 12, colour = "black"),
       legend.position = "none",
       legend.text = element_text(size = 12)) +
    coord_cartesian(xlim = c(0, 20)) +
    ylab(expression(paste("SOM (%)"))) +
    scale_colour_manual(values = c("darkorchid4", "olivedrab", "darkgoldenrod"),
                      labels = c("  oyster",
                                 "  marsh",
                                 "  sandflat"))

p7.BD <- sed.join %>%
  filter(variable == "BulkDensity") %>%
  ggplot(aes(Age, value, colour = Habitat)) +
  geom_point(size = 2) +
  geom_smooth(aes(group = Habitat), method = "lm", formula = y ~ poly(x,2), se = F, size = 1) +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  theme(panel.background = element_rect(fill = "grey96", colour = NA),
       axis.title.x = element_blank(),
       axis.title.y = element_text(margin = margin(r = 20), size = 15),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_blank(),
       axis.text.y = element_text(size = 12, colour = "black"),
       legend.position = "none") +
    coord_cartesian(xlim = c(0, 20)) +
    ylab(expression(paste("Bulk Density (g ", cm^-3, ")"))) +
    scale_colour_manual(values = c("darkorchid4", "olivedrab", "darkgoldenrod"),
                      labels = c("  oyster",
                                 "  marsh",
                                 "  sandflat"))

p8.N2 <- sed.join %>%
  filter(variable == "N2Flux") %>%
  ggplot(aes(Age, value, colour = Habitat)) +
  geom_point(size = 2) +
  geom_smooth(aes(colour = Habitat), method = "lm", formula = y ~ poly(x,2), se = F, size = 1) +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  theme(panel.background = element_rect(fill = "grey96", colour = NA),
       axis.title.x = element_text(margin = margin(t = 15), size = 15),
       axis.title.y = element_text(margin = margin(r = 20), size = 15),
       axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_text(size = 12, colour = "black"),
       axis.text.y = element_text(size = 12, colour = "black"), 
       legend.position = "none") +
  coord_cartesian(xlim = c(0, 20)) +
  xlab("Restored Age (years)") +
  ylab(expression(paste(N[2], " flux (", mu, "mol N ", m^-2, " ", h^-1, ")"))) +
  scale_colour_manual(values = c("darkorchid4", "olivedrab", "darkgoldenrod"),
                      labels = c("  oyster",
                                 "  marsh",
                                 "  sandflat"))


#Putting the above plots together in a combined graph

#Create grobs (grahical units) of each individual plot
g5 <- ggplotGrob(p5.SOD)
g6 <- ggplotGrob(p6.SOM)
g7 <- ggplotGrob(p7.BD)
g8 <- ggplotGrob(p8.N2)

#Bind together the 4 plots using rbind. This will ensure that all the axes line up. Super important! Otherwise, things get wonky when g.arrange is used.
g <- rbind(g5, g6, g7, g8, size = "first")

#This assigns the sizes of the above rbind result to the maximum width of any of the grobs (I think)
g$widths <- unit.pmax(g5$widths, g6$widths, g7$widths, g8$widths)

#Create a separate legend by extracting the legend from the plot created just for a legend. This was necessary because I wanted to make the legend text larger, and couldn't figure out how to do that in one of the 4 regular plots without turning on the legend, which would mess up the alignment.
legend2 <- get_legend(legend.plot)
legend2 <- gtable_filter(ggplotGrob(legend.plot), "guide-box")

#Prepare to export the final graph

grid.newpage()

tiff("Figures\\Thesis\\RT-seasonal-sed-params-by-habitat", width = 350, height = 250, units = "mm", res = 300, compression = "lzw")

#Graph the bound plots and the legend using grid.arrange. Adjust the number of columns and widths accordingly.

grid.arrange(g, legend2, ncol = 2, widths = c(9, 1.5))

dev.off()


#Creating a variation of the first plot in this section: restoration trajectory of sediment parameters collected every season, but only visualized for SUMMER and omitting bulk density. First creating 3 separate plots, then combining them using grid.arrange.

#First creating 3 plots for SOD, SOM, and N2 flux during summer only.

p9.SOD <- sed.join %>%
  filter(variable == "SOD") %>%
  filter(Season == "Summer") %>%
  ggplot(aes(Age, value)) +
  geom_point(size = 2) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = F, size = 1, colour = "mediumblue") +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  theme(panel.background = element_rect(fill = "grey96", colour = NA),
       axis.title.x = element_blank(),
       axis.title.y = element_text(margin = margin(r = 20), size = 15),
       #axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_blank(),
       axis.text.y = element_text(size = 12, colour = "black")) +
    ylab(expression(paste("SOD (", mu, "mol ", O[2], " ", m^-2, " ", h^-1, ")")))

p10.SOM <- sed.join %>%
  filter(variable == "PercentOM") %>%
  filter(Season == "Summer") %>%
  ggplot(aes(Age, value)) +
  geom_point(size = 2) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = F, size = 1, colour = "mediumblue") +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  theme(panel.background = element_rect(fill = "grey96", colour = NA),
       axis.title.x = element_blank(),
       axis.title.y = element_text(margin = margin(r = 20), size = 15),
       #axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_blank(),
       axis.text.y = element_text(size = 12, colour = "black")) +
    ylab(expression(paste("SOM (%)")))

p11.N2 <- sed.join %>%
  filter(variable == "N2Flux") %>%
  filter(Season == "Summer") %>%
  ggplot(aes(Age, value)) +
  geom_point(size = 2) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = F, size = 1, colour = "mediumblue") +
  geom_hline(yintercept = 0, size = 0.2, colour = "grey23") +
  geom_vline(xintercept = 0, size = 0.2, colour = "grey23") +
  theme(panel.background = element_rect(fill = "grey96", colour = NA),
       axis.title.x = element_text(margin = margin(t = 15), size = 15),
       axis.title.y = element_text(margin = margin(r = 20), size = 15),
       axis.line.x = element_line(colour = "black", size = 0.8),
       axis.line.y = element_line(colour = "black", size = 0.8),
       panel.grid.major = element_line(colour = "grey70", size = 0.25),
       axis.text.x = element_text(size = 12, colour = "black"),
       axis.text.y = element_text(size = 12, colour = "black")) +
  xlab("Restored Age (years)") +
  ylab(expression(paste(N[2], " flux (", mu, "mol N ", m^-2, " ", h^-1, ")")))

#Using the grid package to put them all together.
grid.newpage()

tiff("Figures\\Thesis\\RT-sed-params-summer-only", width = 350, height = 250, units = "mm", res = 300, compression = "lzw")

grid.draw(rbind(ggplotGrob(p9.SOD), ggplotGrob(p10.SOM), ggplotGrob(p11.N2), size = "last"))

dev.off()

```


Reading in the data files for each parameter that contain data for each physical core. This is the most basic level of data detail and can be useful for trying to understand trends without obscuring the potential influence of oddball data points.
Data files are read in, then joined so that only matching data points to existing N2 flux data are included. Sequential joins are performed. The NA points are removed to get rid of LoRef & HiRef and Summer 2015 cores. The columns are then reorganized and everything is analyzed with a scatterplot matrix.
```{r combine.files}

O2.concs <- read.csv("O2-conc\\clean\\O2-conc-by-core_with-summer15.csv", header = T, stringsAsFactors = F)

SOD <- read.csv("SOD\\clean\\SOD-by-core_all-seasons_all-sites.csv", header = T, stringsAsFactors = F)

nutfluxes <- read.csv("nutrient-flux\\clean\\nutrient-flux-clean_all-seasons_all-sites.csv", header = T, stringsAsFactors = F)

N2flux <- read.csv("N2-flux\\clean\\N2-flux-by-core_with-summer15.csv", header = T, stringsAsFactors = F)

join1 <- left_join(N2flux, O2.concs)
join2 <- left_join(join1, SOD)
join3 <- left_join(join2, nutfluxes)

final.join <- na.omit(join3)
final.join <- final.join[c("Season", "Site", "CoreName", "CoreNo", "Habitat", "Age", "N2Flux", "O2conc", "SOD", "flux_Nox", "flux_NH3")]

pairs(final.join[, 6:11], upper.panel = panel.cor)

```

Write csvs of data that had been compiled as a result of the above joins for use in PRIMER.
```{r export.csv}

write.csv(final.join, "PRIMER\\clean\\biogeochem-characs_all-seasons_all-sites.csv", row.names = F)

```