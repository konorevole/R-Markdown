---
title: "Main DNF Analysis"
author: "Kathleen Onorevole"
date: "August 18, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Remember to set working directory**

Load the packages required for these analyses. Also source the functions script.
```{r libraries}

library("plyr")
library("dplyr")
library("ggplot2")
library("ggpmisc")
library("lmtest")
library("car")
library("MASS")

source("functions.R")

```

Read in relevant data sets. These should all be taken from the CLEAN folders, which are housed in my master R Markdown folder. The raw data have been processed in separate R Markdown documents; see those files for details. Each parameter has its own folder within the parent folder.
```{r read.in}

all.N2 <- read.csv("N2-flux\\clean\\N2-flux-by-core_with-summer15.csv", header = T, stringsAsFactors = F)

DNE <- read.csv("DNE\\clean\\DNE-clean_no-summer15_all-sites.csv", header = T, stringsAsFactors = F)

```

Set the distinguishing labels as factors and implementing the preferred order. Uses set.factors function written by me.
``` {r order.variables}

all.N2 <- set.factors(all.N2)

all.N2$Habitat <- factor(all.N2$Habitat, levels = c("oyster", "marsh", "Ref", "LoRef", "HiRef"))
all.N2$Age <- as.numeric(all.N2$Age)

DNE <- set.factors.basic(DNE)
DNE <- na.omit(DNE)

```

Checking for normal distributions based on various groupings
``` {r DNF.normality}

bartlett.test(N2Flux ~ Site, data = all.N2)

leveneTest(log_N2Flux ~ Site, data = log.Site)
boxplot(N2Flux ~ Season, data = all.N2)

bartlett.test(log_N2Flux ~ Site, data = log.Site)


test.norm.Season <- all.N2 %>%
  group_by(Season) %>%
  summarise(SW.pvalue = shapiro.test(N2Flux)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

all.N2 %>%
  ggplot(aes(N2Flux)) +
  geom_histogram(stat = "bin", binwidth = 5) +
  facet_grid(Site ~ .)

test.norm.Site <- all.N2 %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(N2Flux)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

log.Site <- all.N2 %>%
  mutate(log_N2Flux = log(N2Flux + 40, 10))

log.Site %>%
  ggplot(aes(N2Flux)) +
  geom_histogram(stat = "bin", binwidth = 5) +
  facet_grid(Site ~ .)

all.N2.age <- add.age(all.N2)
md <- lm(N2Flux ~ Age, data = all.N2.age)
summary(md)
par(mfrow = c(2,2))
plot(md)

mdbc <- boxCox(md, family = "yjPower", lambda = seq(0.5, 1, by = 0.1))
which.max(mdbc$y)
(lambda <- mdbc$x[which.max(mdbc$y)])
mdbest <- lm(I(N2Flux^lambda) ~ Age, data = all.N2.age)
summary(mdbest)
plot(mdbest, which = 1)


lambda.allN2age <- boxCox(N2Flux ~ Site, data = all.N2.age, family = "yjPower")
origdata.yjtrans <- yjPower(all.N2$N2Flux, lambda = 1, jacobian.adjusted = F)

test.norm.log.Site <- log.Site %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(log_N2Flux)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

p1 <- ggplot(all.N2)
p1 + stat_qq(aes(sample = N2Flux, colour = Site)) + geom_smooth(aes(colour = Site), method = "lm")

p2 <- ggplot(log.Site, aes(sample = log_N2Flux)) 
p2 + stat_qq(aes(colour = Site))

qqline(log_N2Flux, data = log.Site, distribution = qnorm)

sqr.Site <- all.N2 %>%
  mutate(sqre_N2Flux = (N2Flux^2),
         logsqre_N2Flux = log(sqre_N2Flux, 10))

test.norm.sqr.Site <- sqr.Site %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(logsqre_N2Flux)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

sqr.Site %>%
  ggplot() +
  stat_qq(aes(sample = logsqre_N2Flux, colour = Site))

#Checking for normal distribution when grouped by Habitat
test.norm.Habitat <- all.N2 %>%
  group_by(Habitat) %>%
  summarise(SW.pvalue = shapiro.test(N2Flux)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue < 0.05, "Normal", "Non-Normal"))

```


``` {r transformations}

#Adding columns for square root and log of (N2 flux +21) to explore normal distribution
basic.N2.T <- mutate(basic.N2,
                     PosN2 = N2Flux + 21,
                     SquareRtN2 = sqrt(N2Flux + 21),
                     logN2 = log(N2Flux + 21, 10))

bartlett.test(SquareRtN2 ~ Age, basic.N2.T)

#Checking square root of (N2 flux +21) for normality with Shapiro-Wilk test
SR.norm.results <- basic.N2.T %>%
  group_by(Season) %>%
  summarise(SW.pvalue = shapiro.test(SquareRtN2)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

SR.norm.results2 <- basic.N2.T %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(SquareRtN2)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

SR.norm.results3 <- basic.N2.T %>%
  group_by(Habitat) %>%
  summarise(SW.pvalue = shapiro.test(SquareRtN2)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

#Creating linear regression for square root transformation and plotting
#QQ plot looks great this time!
plot(SquareRtN2 ~ Age, basic.N2.T)
reg2 <- lm(SquareRtN2 ~ Age, basic.N2.T)
summary(reg2)
par(mfrow = c(2,2))
plot(reg2)

#!!!THIS IS HOW YOU DO A BOXCOX TRANSFORM FINALLY!!!
#Create a boxcox diagram using the command from the MASS package
bctrans <- boxcox(PosN2 ~ Age, data = basic.N2.T,
                    lambda = seq(0, 1, by = 0.1))
#Identify the maximum likelihood value
which.max(bctrans$y)
#Use that maximum likelihood value (from the y axis) to determine the associated lambda (on the x axis)
bctrans$x[which.max(bctrans$y)]
#Take the variable to the power of the lambda to perform the transformation
use.lambda <- mutate(basic.N2.T,
                     N2BoxCox = (((PosN2 ^ 0.464) - 1) / 0.464))

use.lambda.type <- ddply(use.lambda, c("Season", "Site", "CoreName", "Habitat", "Age"), summarise,
                         Avg_N2BC = mean(N2BoxCox))

write.csv(use.lambda, "PRIMER\\clean\\N2_BoxCoxTransform.csv", row.names = F)
write.csv(use.lambda.type, "PRIMER\\clean\\N2_BoxCoxTransform-by-type.csv", row.names = F)

hist(use.lambda$N2BoxCox)
qqnorm(use.lambda$N2BoxCox)
qqline(use.lambda$N2BoxCox)
plot(use.lambda$N2BoxCox)
#Visualizing the regression with the Box Cox transformation
reg4 <- lm(N2BoxCox ~ Age, use.lambda)
par(mfrow = c(2,2))
plot(reg4)

#Checking for normality and heteroskedasticity
bartlett.test(N2BoxCox ~ Age, use.lambda)

BC.norm.results <- use.lambda %>%
  group_by(Season) %>%
  summarise(SW.pvalue = shapiro.test(N2BoxCox)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

BC.norm.results2 <- use.lambda %>%
  group_by(Site) %>%
  summarise(SW.pvalue = shapiro.test(N2BoxCox)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

BC.norm.results3 <- use.lambda %>%
  group_by(Habitat) %>%
  summarise(SW.pvalue = shapiro.test(N2BoxCox)$p.value) %>%
  mutate(Result = ifelse(SW.pvalue > 0.05, "Normal", "Non-Normal"))

```

Running ANOVAs on the basic N2 flux 
```{r DNF.anovas}

season.anova <- aov(N2Flux ~ Season, data = N2.hab)
summary(season.anova)

habitat.anova <- aov(N2Flux ~ Habitat, data = N2.hab)
summary(habitat.anova)

site.anova <- aov(N2Flux ~ Site, data = N2.hab)
summary(site.anova)

TukeyHSD(site.anova)

#Run ANOVA treating Season & Habitat independently
anova.N2 <- aov(N2Flux ~ Season + Habitat, data = N2.hab)
summary(anova.N2)

TukeyHSD(anova.N2)

#Run ANOVA incorporating interaction between Season & Habitat
interaction.anova.N2 <- aov(N2Flux ~ Season * Habitat, data = N2.hab)
summary(interaction.anova.N2)

nested.anova <- aov(N2Flux ~ (Season + Habitat) / CoreName, data = N2.hab)
summary(nested.anova)

#Running ANOVAS for Box Cox transformed N2 values

season.anova.T <- aov(N2BoxCox ~ Season, data = use.lambda)
summary(season.anova.T)
TukeyHSD(season.anova.T)

habitat.anova.T <- aov(N2BoxCox ~ Habitat, data = use.lambda)
summary(habitat.anova.T)
TukeyHSD(habitat.anova.T)

site.anova.T <- aov(N2BoxCox ~ Site, data = use.lambda)
summary(site.anova.T)
TukeyHSD(site.anova.T)

```

Graphing DNE.
``` {r DNE.graphs}

DNE %>%
  ggplot(aes(Site, DNE, fill = CoreName)) +
  geom_bar(stat = "identity", position = "dodge") + facet_grid(Season ~ .)

```

Creating linear correlations for 
``` {r linear.models}

#Eliminate Summer 2015 data points
no.summer15 <- all.N2[!all.N2$Season == "Summer15", ]

#Eliminate LoRef and HiRef
basic.N2 <- no.summer15[!no.summer15$Habitat == "LoRef", ]
basic.N2 <- basic.N2[!basic.N2$Habitat == "HiRef", ]

#Calculate summary stats based on core type
type.basic.N2 <- full.summary(basic.N2)

#Creating linear regression for untransformed data and plotting results
reg1 <- lm(formula = N2Flux ~ Age, data = basic.N2)
summary(reg1)
par(mfrow = c(2,2))
plot(reg1)

#Graphing relationship b/t age and N2 flux
formula <- y ~ x

p1 <- ggplot(basic.N2, aes(Age, N2Flux, colour = Habitat))
p1 + geom_point() +
  geom_smooth(method = "lm", formula = formula, se = F) +
  stat_poly_eq(formula = formula,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               parse = T) +
  stat_fit_glance(method = "lm",
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")

basic.N2 %>%
  ggplot(aes(Age, N2BoxCox, colour = Habitat)) +
  geom_point() +
  facet_grid(Season ~ .) +
  geom_smooth(method = "lm", formula = formula, se = F) +
  stat_poly_eq(formula = formula,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               parse = T) +
  stat_fit_glance(method = "lm",
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")

basic.N2 %>%
  ggplot(aes(Age, N2Flux, colour = Season)) +
  geom_point() +
  facet_grid(Habitat ~ .) +
  geom_smooth(method = "lm", formula = formula, se = F) +
  stat_poly_eq(formula = formula,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               parse = T) +
  stat_fit_glance(method = "lm",
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")

basic.N2 %>%
  ggplot(aes(Age, N2Flux, colour = CoreName)) +
  geom_point() +
  facet_grid(Season ~ .) +
  geom_smooth(method = "lm", formula = formula, se = F) +
  stat_poly_eq(formula = formula,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               parse = T) +
  stat_fit_glance(method = "lm",
                  geom = "text",
                  aes(label = paste("P-value =", signif(..p.value.., digits = 4), sep = "")),
                  label.x.npc = "right")
  
```

