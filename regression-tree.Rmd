---
title: "Regression tree"
author: "Kathleen Onorevole"
date: "September 15, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document contains code for a regression tree with denitrification rates as the dependent variable and all other variables as potential explanatory variables.

**Remember to set working directory**

Load the packages and functions needed for this analysis.
```{r libraries}

library("plyr")
library("dplyr")
library("car")
library("ggplot2")
library("ggpmisc")
library("rpart")
library("rpart.plot")


source("functions.R")

```

Read in data frames needed for this analysis.
``` {r load.data}

inund <- read.csv("Inundation\\clean\\inundation-clean_all-sites_all-seasons.csv", header = T)
inund$Age <- as.numeric(inund$Age)

SOM <- read.csv("LOI\\clean\\LOI-by-type_all-seasons_all-sites.csv", header = T)

SOD <- read.csv("SOD\\clean\\SOD-by-type_all-seasons_all-sites.csv", header = T)

O2conc <- read.csv("O2-conc\\clean\\O2-conc-by-type_all-seasons_all-sites.csv", header = T)

nutflux <- read.csv("nutrient-flux\\clean\\nutrient-flux-by-type_all-seasons_all-sites.csv", header = T)

DNF <- read.csv("N2-flux\\clean\\N2-flux-by-type_all-seasons_all-sites.csv", header = T)

```

Merging the variables into one data frame for regression tree analysis, "master".
``` {r combine.data}

#Sequential merges to combine all relevant data frames into a master data frame
#Includes all cores and seasons (including Summer 2015) initially- easier to double-check
#sort = F maintains original ordering scheme
m1 <- merge(inund, SOM, by = c("Site", "Season", "CoreName"), all.x = T, sort = F)
m2 <- merge(m1, SOD, by = c("Site", "Season", "CoreName"), all.x = T, sort = F)
m3 <- merge(m2, O2conc, by = c("Site", "Season", "CoreName"), all.x = T, sort = F)
m4 <- merge(m3, nutflux, by = c("Site", "Season", "CoreName"), all.x = T, sort = F)
m5 <- merge(m4, DNF, by = c("Site", "Season", "CoreName"), all.x = T, sort = F)

#Ensuring that preferred order is preserved
#This will turn Summer 2015 values to NA for easy elimination
m5$Season <- factor(m5$Season, levels = c("Summer", "Fall", "Winter", "Spring"))
m5$Site <- factor(m5$Site, levels = c("IMS", "Carrot", "NOAA", "Army"))
m5$CoreName <- factor(m5$CoreName, levels = c("LO", "HO", "LM", "MM", "HM", "Ref"))
m5$Habitat <- factor(m5$Habitat, levels = c("oyster", "marsh", "Ref"))

#Should only get rid of Summer 2015 rows
master <- na.omit(m5)

#Use functions I wrote to add columns with Habitat & Season represented by #s
#Just in case rpart was tempted to do something weird with the characters
master <- season.numbers(master)
master <- habitat.numbers(master)

#Reorder the columns
master <- master[c("Season", "SeasonNumber", "Site", "Age", "CoreName", "Habitat", "HabitatNumber",  "avg_N2Flux", "Perc_Inun", "avg_PercentOM", "avg_SOD", "avg_O2conc", "avg_flux_NOx", "avg_flux_NH3")]

#Rename the columns so they're less bulky
master <- plyr::rename(master, c("avg_N2Flux" = "N2flux", "Perc_Inun" = "Inund", "avg_PercentOM" = "SOM", "avg_SOD" = "SOD", "avg_O2conc" = "O2conc", "avg_flux_NOx" = "NOxflux", "avg_flux_NH3" = "NH3flux"))

summer <- master[master$Season == "Summer", ]
fall <- master[master$Season == "Fall", ]
winter <- master[master$Season == "Winter", ]
spring <- master[master$Season == "Spring", ]

IMS <- master[master$Site == "IMS", ]
Carrot <- master[master$Site == "Carrot", ]
NOAA <- master[master$Site == "NOAA", ]
Army <- master[master$Site == "Army", ]

```

Using master data frame to build regression tree.
```{r building.tree}

fit.all <- rpart(N2flux ~ SeasonNumber + HabitatNumber + Age + Inund + SOM + SOD + O2conc + NOxflux + NH3flux, method = "anova", data = master)

summary(fit.all)
plot(fit.all, uniform = T)
text(fit.all, use.n = T, all = T, cex = 0.8)

par(mfrow = c(1,2))

pruned.all <- prune(fit.all, cp = 0.04)
plot(pruned.all, uniform = T)
text(pruned.all, use.n = T, all = T, cex = 0.8)


fit.BCG <- rpart(N2flux ~ Inund + SOM + SOD + O2conc + NOxflux + NH3flux, method = "anova", data = master)
summary(fit.BCG)
fit.BCG

plotcp(fit.BCG)
plot(fit.BCG, uniform = T)
text(fit.BCG, use.n = T, all = T, cex = 0.8)

#Research indicates that the tree should be pruned by consulting the cptable, included in summary
#In the table, xerror = cross-validation error, xstd = standard deviation, & CP = complexity parameter
#(CP explains how much of the original variablility is predicted by the split)
#Ideally, there is what's called the 1-SE rule: find the lowest xerror, then add the corresponding
#xstd. Look for the line in cptable that has the lowest # of splits with an xerror less than the
#result of the addition. The CP of that row should be used to prune the tree.

#In this case, the corresponding CP was 0.0417 (3 splits, so 4 nodes).
pruned.BCG <- prune(fit.BCG, cp = 0.04)
plot(pruned.BCG, uniform = T)
text(pruned.BCG, use.n = T, all = T, cex = 0.8)


rsq.rpart(pruned.BCG)

summer.tree <- rpart(N2flux ~ Inund + SOM + SOD + O2conc + NOxflux + NH3flux, method = "anova", data = summer)

summer.tree$cptable
summer.prune <- prune(summer.tree, cp = summer.tree$cptable[which.min(summer.tree$cptable[ ,"xerror"]), "CP"])
plot(summer.prune, uniform = T, main = "Pruned Regression Tree for Summer DNF Rates", cex = 0.5)
text(summer.prune, use.n = T, all = T, cex = 0.5)

prp(summer.tree)

printcp(summer.tree)

plot(summer.tree, uniform = T)
text(summer.tree, use.n = T, all = T, cex = 0.8)


fall.tree <- rpart(N2flux ~ Inund + SOM + SOD + O2conc + NOxflux + NH3flux, method = "anova", data = fall, control = rpart.control(minsplit = 8))

prp(fall.tree)

winter.tree <- rpart(N2flux ~ Inund + SOM + SOD + O2conc + NOxflux + NH3flux, method = "anova", data = winter, control = rpart.control(minsplit = 8))

prp(winter.tree)

spring.tree <- rpart(N2flux ~ Inund + SOM + SOD + O2conc + NOxflux + NH3flux, method = "anova", data = spring, control = rpart.control(minsplit = 8))

prp(spring.tree)

IMS.tree <- rpart(N2flux ~ Inund + SOM + SOD + O2conc + NOxflux + NH3flux, method = "anova", data = IMS, control = rpart.control(minsplit = 2))
prp(IMS.tree)

Carrot.tree <- rpart(N2flux ~ Inund + SOM + SOD + O2conc + NOxflux + NH3flux, method = "anova", data = Carrot, control = rpart.control(minsplit = 2))
prp(Carrot.tree)

NOAA.tree <- rpart(N2flux ~ Inund + SOM + SOD + O2conc + NOxflux + NH3flux, method = "anova", data = NOAA, control = rpart.control(minsplit = 2))
prp(NOAA.tree)

Army.tree <- rpart(N2flux ~ Inund + SOM + SOD + O2conc + NOxflux + NH3flux, method = "anova", data = Army, control = rpart.control(minsplit = 2))
prp(Army.tree)

```


